<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments :: head('Routes')}"><title>Routes</title></head>
<body>

<aside th:replace="~{admin/fragments :: sidebar('routes')}"></aside>

<main class="main-content" id="mainContent">
  <header th:replace="~{admin/fragments :: topHeader('Routes Management')}"></header>

  <div class="page-content">
    <div class="stats-row">
      <div class="stat-box">
        <h4>Total Routes</h4>
        <p th:text="${totalRoutes} ?: '0'">0</p>
      </div>
      <div class="stat-box">
        <h4>Active Routes</h4>
        <p th:text="${enabledRoutes} ?: '0'">0</p>
      </div>
      <div class="stat-box">
        <h4>Countries</h4>
        <p th:text="${activeCountries} ?: '0'">0</p>
      </div>
      <div class="stat-box">
        <h4>Avg Price</h4>
        <p th:text="'$' + ${averagePrice} ?: '0.00'">$0.00</p>
      </div>
    </div>

    <div class="filters-section">
      <form th:action="@{/admin/routes}" method="get">
        <div class="filters-grid">
          <div class="filter-group">
            <label>Search Location</label>
            <label>
              <input type="text" name="search" th:value="${param.search}" placeholder="Start or End location...">
            </label>
          </div>
          <div class="filter-group">
            <label>Country</label>
            <label>
              <select name="country">
                <option value="">All Countries</option>
                <option th:each="c : ${countries}" th:value="${c}" th:text="${c}"
                        th:selected="${param.country == c}"></option>
              </select>
            </label>
          </div>
          <div class="filter-group">
            <label>State</label>
            <label>
              <input type="text" name="state" th:value="${param.state}" placeholder="State...">
            </label>
          </div>
          <div class="filter-group">
            <label>City</label>
            <label>
              <input type="text" name="city" th:value="${param.city}" placeholder="City...">
            </label>
          </div>
          <div class="filter-group">
            <label>Status</label>
            <label>
              <select name="enabled">
                <option value="">All Status</option>
                <option value="true" th:selected="${param.enabled == 'true'}">Active</option>
                <option value="false" th:selected="${param.enabled == 'false'}">Disabled</option>
              </select>
            </label>
          </div>
          <div class="filter-group">
            <label>Sort By</label>
            <label>
              <select name="sortBy">
                <option value="id" th:selected="${param.sortBy == 'id'}">ID</option>
                <option value="start" th:selected="${param.sortBy == 'start'}">Start Location</option>
                <option value="end" th:selected="${param.sortBy == 'end'}">End Location</option>
                <option value="price" th:selected="${param.sortBy == 'price'}">Price</option>
                <option value="country" th:selected="${param.sortBy == 'country'}">Country</option>
              </select>
            </label>
          </div>
        </div>
        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
          <a href="/admin/routes" class="btn btn-secondary">Clear</a>
          <a href="/admin/routes/create" class="btn btn-primary" style="margin-left: auto;">+ Create Route</a>
        </div>
      </form>
    </div>

    <div class="routes-table">
      <div class="table-header">
        <h3>All Routes (<span th:text="${routes.totalElements}">0</span>)</h3>
      </div>

      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>Route</th>
          <th>Location</th>
          <th>Price</th>
          <th>Providers</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="route : ${routes.content}">
          <td>
            <span class="route-id" th:text="'#' + ${route.id}">ID</span>
          </td>
          <td>
            <div class="route-info">
              <span class="route-from">üìç <strong th:text="${route.start}">From</strong></span>
              <span class="route-arrow">‚Üí</span>
              <span class="route-to">üìå <strong th:text="${route.end}">To</strong></span>
            </div>
          </td>
          <td>
            <div class="location-info">
              <span th:text="${route.city + ', ' + route.state}">City, State</span>
              <br>
              <small th:text="${route.country}" style="color: #999;">Country</small>
            </div>
          </td>
          <td>
            <span class="price" th:text="'$' + ${#numbers.formatDecimal(route.price, 1, 2)}">$0.00</span>
          </td>
          <td>
            <div class="providers-info">
              <span class="provider-count" th:text="${providerCounts[route.id]} + ' provider(s)'">0 providers</span>
              <div class="provider-list" th:if="${routeProviders[route.id] != null && !routeProviders[route.id].isEmpty()}">
                <small th:each="provider, iterStat : ${routeProviders[route.id]}"
                       th:text="${provider.name} + ${iterStat.last ? '' : ', '}">Provider</small>
              </div>
            </div>
          </td>
          <td>
            <span class="badge badge-success" th:if="${route.isEnabled}">Active</span>
            <span class="badge badge-warning" th:unless="${route.isEnabled}">Disabled</span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-view" th:onclick="'viewRoute(' + ${route.id} + ')'" title="View">üëÅÔ∏è</button>
              <button class="btn-icon btn-edit" th:onclick="'editRoute(' + ${route.id} + ')'" title="Edit">‚úèÔ∏è</button>
              <button class="btn-icon"
                      th:classappend="${route.isEnabled} ? 'btn-warning' : 'btn-success'"
                      th:onclick="'toggleRoute(' + ${route.id} + ')'"
                      th:title="${route.isEnabled} ? 'Disable' : 'Enable'">
                <span th:text="${route.isEnabled} ? 'üîí' : 'üîì'">Toggle</span>
              </button>
              <button class="btn-icon btn-delete" th:onclick="'deleteRoute(' + ${route.id} + ')'" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>

      <div class="pagination" th:if="${routes.totalPages > 1}">
        <button th:disabled="${routes.first}"
                th:onclick="'navigateToPage(' + ${routes.number - 1} + ')'">
          Previous
        </button>
        <button th:each="i : ${#numbers.sequence(0, routes.totalPages - 1)}"
                th:text="${i + 1}"
                th:classappend="${i == routes.number} ? 'current-page' : ''"
                th:onclick="'navigateToPage(' + ${i} + ')'">
        </button>
        <button th:disabled="${routes.last}"
                th:onclick="'navigateToPage(' + ${routes.number + 1} + ')'">
          Next
        </button>
      </div>
    </div>
  </div>
</main>

<div th:replace="~{admin/fragments :: commonScripts}"></div>

<style>
  .route-info {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .route-arrow {
    color: #667eea;
    font-weight: bold;
  }

  .providers-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .provider-count {
    font-weight: 600;
    color: #667eea;
  }

  .provider-list {
    font-size: 0.85rem;
    color: #666;
  }

  .price {
    font-size: 1.1rem;
    font-weight: 600;
    color: #10b981;
  }

  .route-id {
    font-weight: 600;
    color: #667eea;
  }

  .btn-warning {
    background: #fef3c7;
    color: #92400e;
  }

  .btn-success {
    background: #d1fae5;
    color: #065f46;
  }
</style>

<script>
  function viewRoute(id) {
    window.location.href = '/admin/routes/' + id;
  }

  function editRoute(id) {
    window.location.href = '/admin/routes/' + id + '/edit';
  }

  function toggleRoute(id) {
    if (confirm('Are you sure you want to toggle this route status?')) {
      fetch('/admin/routes/' + id + '/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
              .then(response => response.json())
              .then(data => {
                if (data.message) {
                  alert(data.message);
                  window.location.reload();
                } else {
                  alert('Failed to toggle route');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('Failed to toggle route');
              });
    }
  }

  function deleteRoute(id) {
    if (confirm('Are you sure you want to delete this route? This action cannot be undone.')) {
      fetch('/admin/routes/' + id + '/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
              .then(response => response.json())
              .then(data => {
                if (data.message) {
                  alert(data.message);
                  window.location.reload();
                } else {
                  alert('Failed to delete route');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete route');
              });
    }
  }

  function navigateToPage(page) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('page', page);
    window.location.href = '/admin/routes?' + urlParams.toString();
  }
</script>
</body>
</html>