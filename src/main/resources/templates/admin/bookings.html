<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments :: head('Bookings')}"></head>
<body>

<aside th:replace="~{admin/fragments :: sidebar('bookings')}"></aside>

<main class="main-content" id="mainContent">
    <header th:replace="~{admin/fragments :: topHeader('Bookings Management')}"></header>

    <div class="page-content">
        <div class="stats-row">
            <div class="stat-box">
                <h4>Total Bookings</h4>
                <p th:text="${totalBookings} ?: '0'">0</p>
            </div>
            <div class="stat-box">
                <h4>Pending</h4>
                <p th:text="${pendingBookings} ?: '0'">0</p>
            </div>
            <div class="stat-box">
                <h4>Confirmed</h4>
                <p th:text="${confirmedBookings} ?: '0'">0</p>
            </div>
            <div class="stat-box">
                <h4>Completed</h4>
                <p th:text="${completedBookings} ?: '0'">0</p>
            </div>
        </div>

        <div class="filters-section">
            <form th:action="@{/admin/bookings}" method="get">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="">All Status</option>
                            <option value="PENDING" th:selected="${param.status == 'PENDING'}">Pending</option>
                            <option value="CONFIRMED" th:selected="${param.status == 'CONFIRMED'}">Confirmed</option>
                            <option value="COMPLETED" th:selected="${param.status == 'COMPLETED'}">Completed</option>
                            <option value="CANCELLED" th:selected="${param.status == 'CANCELLED'}">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Priority</label>
                        <select name="priority">
                            <option value="">All Priorities</option>
                            <option value="HIGH" th:selected="${param.priority == 'HIGH'}">High</option>
                            <option value="MEDIUM" th:selected="${param.priority == 'MEDIUM'}">Medium</option>
                            <option value="LOW" th:selected="${param.priority == 'LOW'}">Low</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>City</label>
                        <input type="text" name="city" th:value="${param.city}" placeholder="City...">
                    </div>
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" name="fromDate" th:value="${param.fromDate}">
                    </div>
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="/admin/bookings" class="btn btn-secondary">Clear</a>
                </div>
            </form>
        </div>

        <div class="bookings-table">
            <div class="table-header">
                <h3>All Bookings (<span th:text="${bookings.totalElements}">0</span>)</h3>
            </div>

            <table>
                <thead>
                <tr>
                    <th>Booking ID</th>
                    <th>Route</th>
                    <th>Type</th>
                    <th>Client</th>
                    <th>Service Date</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="booking : ${bookings.content}">
                    <td>
                        <div class="booking-info">
                            <span class="booking-id" th:text="'#' + ${booking.id}">ID</span>
                            <span class="booking-date" th:text="${#temporals.format(booking.createdDate, 'MMM dd, yyyy')}">Date</span>
                        </div>
                    </td>
                    <td>
                        <div class="location-info">
                            <span class="location-from">üìç <span th:text="${booking.pickUpLocation}">From</span></span>
                            <span class="location-to">üìå <span th:text="${booking.destination}">To</span></span>
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-passenger" th:if="${booking.isPassenger}">Passenger</span>
                        <span class="badge badge-cargo" th:if="${booking.isCargo}">Cargo</span>
                    </td>
                    <td th:text="${clientNames[booking.id]}">Client Name</td>
                    <td th:text="${booking.serviceDate != null ? #temporals.format(booking.serviceDate, 'MMM dd, yyyy HH:mm') : 'N/A'}">Date</td>
                    <td>
                        <span th:if="${booking.priority == 'HIGH'}">High</span>
                        <span th:if="${booking.priority == 'MEDIUM'}">Medium</span>
                        <span th:if="${booking.priority == 'LOW'}">Low</span>
                    </td>
                    <td>
                        <span class="badge badge-pending" th:if="${booking.status == 'PENDING'}">Pending</span>
                        <span class="badge badge-confirmed" th:if="${booking.status == 'CONFIRMED'}">Confirmed</span>
                        <span class="badge badge-completed" th:if="${booking.status == 'COMPLETED'}">Completed</span>
                        <span class="badge badge-cancelled" th:if="${booking.status == 'CANCELLED'}">Cancelled</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" th:onclick="'viewBooking(' + ${booking.id} + ')'">üëÅÔ∏è</button>
                            <button class="btn-icon btn-edit" th:onclick="'editBooking(' + ${booking.id} + ')'">‚úèÔ∏è</button>
                            <button class="btn-icon btn-delete" th:onclick="'deleteBooking(' + ${booking.id} + ')'">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="pagination" th:if="${bookings.totalPages > 1}">
                <button th:disabled="${bookings.first}"
                        th:onclick="'window.location.href=\'/admin/bookings?page=' + ${bookings.number - 1} + '&size=' + ${bookings.size} + '\''">
                    Previous
                </button>
                <button th:each="i : ${#numbers.sequence(0, bookings.totalPages - 1)}"
                        th:text="${i + 1}"
                        th:classappend="${i == bookings.number} ? 'current-page' : ''"
                        th:onclick="'window.location.href=\'/admin/bookings?page=' + ${i} + '&size=' + ${bookings.size} + '\''">
                </button>
                <button th:disabled="${bookings.last}"
                        th:onclick="'window.location.href=\'/admin/bookings?page=' + ${bookings.number + 1} + '&size=' + ${bookings.size} + '\''">
                    Next
                </button>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{admin/fragments :: commonScripts}"></div>

<script>
    function viewBooking(id) { window.location.href = '/admin/bookings/' + id; }
    function editBooking(id) { window.location.href = '/admin/bookings/' + id + '/edit'; }
    function deleteBooking(id) {
        if (confirm('Are you sure you want to delete this booking?')) {
            fetch('/admin/bookings/' + id + '/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                .then(response => {
                    if (response.ok) { alert('Booking deleted'); window.location.reload(); }
                    else { alert('Failed to delete'); }
                });
        }
    }
</script>
</body>
</html>