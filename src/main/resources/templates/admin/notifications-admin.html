<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/fragments :: head('Notifications Management')}"></head>
<body>
<style>
    /* Custom Checkbox Styling */
    .notification-col {
        text-align: center;
        width: 100px;
    }

    .notification-cell {
        text-align: center;
    }

    .notification-checkbox {
        position: relative;
        width: 24px;
        height: 24px;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        border: 2px solid #d1d5db;
        border-radius: 6px;
        background: white;
        transition: all 0.3s ease;
    }

    .notification-checkbox:hover {
        border-color: #667eea;
    }

    .notification-checkbox:checked {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }

    .notification-checkbox:checked::after {
        content: 'âœ“';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 14px;
        font-weight: bold;
    }

    .notification-checkbox:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Roles */
    .user-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .user-name {
        font-weight: 600;
        color: #333;
        font-size: 0.95rem;
    }

    .user-email {
        font-size: 0.8rem;
        color: #999;
    }

    .user-id {
        font-size: 0.75rem;
        color: #ccc;
    }

    .user-role {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .role-client {
        background: #dbeafe;
        color: #1e40af;
    }

    .role-provider {
        background: #d1fae5;
        color: #065f46;
    }

    .role-driver {
        background: #fef3c7;
        color: #92400e;
    }

    .role-admin {
        background: #fce7f3;
        color: #831843;
    }

    /* Toast Notification */
    .toast {
        position: fixed;
        top: 90px;
        right: 30px;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        display: none;
        align-items: center;
        gap: 12px;
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        min-width: 300px;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .toast.show {
        display: flex;
    }

    .toast.success {
        background: #10b981;
        color: white;
    }

    .toast.error {
        background: #ef4444;
        color: white;
    }

    .toast-icon {
        font-size: 1.5rem;
    }

    .toast-message {
        font-weight: 600;
        font-size: 0.95rem;
    }

    /* Loading Spinner */
    .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner-overlay.active {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<aside th:replace="~{admin/fragments :: sidebar('notifications')}"></aside>

<main class="main-content" id="mainContent">
    <header th:replace="~{admin/fragments :: topHeader('Notifications Management')}"></header>

    <div class="page-content">
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-info"><h4>Total Users</h4>
                    <p th:text="${totalUsers} ?: '0'">0</p></div>
                <div class="stat-icon">ðŸ‘¥</div>
            </div>
            <div class="stat-box">
                <div class="stat-info"><h4>Email Enabled</h4>
                    <p th:text="${emailEnabledCount} ?: '0'">0</p></div>
                <div class="stat-icon">ðŸ“§</div>
            </div>
            <div class="stat-box">
                <div class="stat-info"><h4>SMS Enabled</h4>
                    <p th:text="${smsEnabledCount} ?: '0'">0</p></div>
                <div class="stat-icon">ðŸ’¬</div>
            </div>
            <div class="stat-box">
                <div class="stat-info"><h4>Push Enabled</h4>
                    <p th:text="${pushEnabledCount} ?: '0'">0</p></div>
                <div class="stat-icon">ðŸ””</div>
            </div>
            <div class="stat-box">
                <div class="stat-info"><h4>In-App Enabled</h4>
                    <p th:text="${inAppEnabledCount} ?: '0'">0</p></div>
                <div class="stat-icon">ðŸ“±</div>
            </div>
        </div>

        <div class="filters-section">
            <form th:action="@{/admin/notifications}" method="get">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Search Users</label>
                        <input type="text" name="search" th:value="${param.search}" placeholder="Name, email or ID...">
                    </div>
                    <div class="filter-group">
                        <label>User Role</label>
                        <select name="role">
                            <option value="">All Roles</option>
                            <option value="CLIENT" th:selected="${param.role == 'CLIENT'}">Client</option>
                            <option value="PROVIDER" th:selected="${param.role == 'PROVIDER'}">Provider</option>
                            <option value="DRIVER" th:selected="${param.role == 'DRIVER'}">Driver</option>
                            <option value="ADMIN" th:selected="${param.role == 'ADMIN'}">Admin</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Sort By</label>
                        <select name="sortBy">
                            <option value="firstName"
                                    th:selected="${param.sortBy == 'firstName' || param.sortBy == null}">Name
                            </option>
                            <option value="email" th:selected="${param.sortBy == 'email'}">Email</option>
                            <option value="roles" th:selected="${param.sortBy == 'roles'}">Role</option>
                            <option value="id" th:selected="${param.sortBy == 'id'}">User ID</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <a href="/admin/notifications" class="btn btn-secondary">Clear Filters</a>
                </div>
            </form>
        </div>

        <div class="users-table">
            <div class="table-header">
                <h3>User Notification Preferences (<span th:text="${users.totalElements}">0</span> users)</h3>
            </div>

            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>User</th>
                    <th>Role</th>
                    <th>Location</th>
                    <th class="notification-col">ðŸ“§ Email</th>
                    <th class="notification-col">ðŸ’¬ SMS</th>
                    <th class="notification-col">ðŸ”” Push</th>
                    <th class="notification-col">ðŸ“± In-App</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user, iterStat : ${users.content}">
                    <td th:text="${iterStat.count + (users.number * users.size)}">1</td>
                    <td>
                        <div class="user-info">
                            <span class="user-name" th:text="${user.firstName} + ' ' + ${user.lastName}">Name</span>
                            <span class="user-email" th:text="${user.email}">email</span>
                            <span class="user-id" th:text="'ID: ' + ${user.id}">ID</span>
                        </div>
                    </td>
                    <td>
                        <span class="user-role" th:classappend="'role-' + ${#strings.toLowerCase(user.roles)}"
                              th:text="${user.roles}">ROLE</span>
                    </td>
                    <td th:text="${user.city != null ? user.city : 'N/A'}">Location</td>

                    <td class="notification-cell">
                        <input type="checkbox" class="notification-checkbox"
                               th:checked="${userPreferences[user.id]['EMAIL']}"
                               th:data-user-id="${user.id}" data-channel="EMAIL"
                               onchange="toggleNotification(this)">
                    </td>

                    <td class="notification-cell">
                        <input type="checkbox" class="notification-checkbox"
                               th:checked="${userPreferences[user.id]['SMS']}"
                               th:data-user-id="${user.id}" data-channel="SMS"
                               onchange="toggleNotification(this)">
                    </td>

                    <td class="notification-cell">
                        <input type="checkbox" class="notification-checkbox"
                               th:checked="${userPreferences[user.id]['PUSH']}"
                               th:data-user-id="${user.id}" data-channel="PUSH"
                               onchange="toggleNotification(this)">
                    </td>

                    <td class="notification-cell">
                        <input type="checkbox" class="notification-checkbox"
                               th:checked="${userPreferences[user.id]['IN_APP']}"
                               th:data-user-id="${user.id}" data-channel="IN_APP"
                               onchange="toggleNotification(this)">
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="pagination" th:if="${users.totalPages > 1}">
                <button th:disabled="${users.first}" th:onclick="'navigateToPage(' + ${users.number - 1} + ')'">
                    Previous
                </button>
                <button th:each="i : ${#numbers.sequence(0, users.totalPages - 1)}"
                        th:text="${i + 1}"
                        th:classappend="${i == users.number} ? 'current-page' : ''"
                        th:onclick="'navigateToPage(' + ${i} + ')'">
                </button>
                <button th:disabled="${users.last}" th:onclick="'navigateToPage(' + ${users.number + 1} + ')'">Next
                </button>
            </div>
        </div>
    </div>
</main>

<div class="toast" id="toast">
    <span class="toast-icon" id="toastIcon">âœ“</span>
    <div class="toast-content">
        <div class="toast-message" id="toastMessage">Success!</div>
    </div>
</div>
<div class="spinner-overlay" id="spinnerOverlay">
    <div class="spinner"></div>
</div>

<div th:replace="~{admin/fragments :: commonScripts}"></div>
<script>
    async function toggleNotification(checkbox) {
        const userId = checkbox.getAttribute('data-user-id');
        const channel = checkbox.getAttribute('data-channel');
        const enabled = checkbox.checked;
        showSpinner();

        try {
            const response = await fetch(`/admin/notifications/preferences/channel?userId=${userId}&channel=${channel}&enabled=${enabled}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'}
            });
            hideSpinner();
            if (response.ok) {
                showToast(`${channel} notifications ${enabled ? 'enabled' : 'disabled'}`, 'success');
            } else {
                checkbox.checked = !enabled;
                const errorData = await response.json();
                showToast(errorData.message || 'Failed to update', 'error');
            }
        } catch (error) {
            hideSpinner();
            checkbox.checked = !enabled;
            showToast('An error occurred', 'error');
        }
    }

    function navigateToPage(pageNumber) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', pageNumber);
        window.location.href = url.toString();
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        document.getElementById('toastMessage').textContent = message;
        const icon = document.getElementById('toastIcon');
        icon.textContent = type === 'success' ? 'âœ“' : 'âœ—';
        toast.className = 'toast ' + type + ' show';
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showSpinner() {
        document.getElementById('spinnerOverlay').classList.add('active');
    }

    function hideSpinner() {
        document.getElementById('spinnerOverlay').classList.remove('active');
    }
</script>
</body>
</html>